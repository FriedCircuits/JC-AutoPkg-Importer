# JumpCloud AutoPkg Importer

JumpCloud can leverage [AutoPkg](https://github.com/autopkg/autopkg) to automate package testing and deployment. Administrators familiar with AutoPkg can use .jumpcloud template recipes to develop their own .pkg overrides. Those unfamiliar with AutoPkg should visit the [AutoPkg wiki](https://github.com/autopkg/autopkg/wiki) page for more documentation. In sum, the JumpCloudImporter was developed to help admins import packages packages to distribution points and automatically create deployable JumpCloud commands for JumpCloud systems.

## Installation and Setup

### Prerequisites

- Python 3.x.x
- JumpCloud Tenant
- AutoPkg
- awscli to store AWS credentials
- Python Modules installed to AutoPkg's embedded copy of Python
  - JumpCloud APIs V1 and V2
  - Boto3
  
### Optional Settings

- JumpCloud System Insights

After installing the latest version of AutoPKG, add your JumpCloud API key to the AutoPkg:

`defaults write ~/Library/Preferences/com.github.autopkg.plist JC_API yourApiKey`

Note: Your API key is stored on a local system when the above command is used, evaluate whether or not this meets the security requirements of your organization. Receipts for each package are generated by default, those receipts will contain your a copy of your API key unless other specified actions are made.

Install the [JumpCloud Python APIs, v1 and v2](https://github.com/TheJumpCloud/jcapi-python)

Install AWS Cli and add the distribution point to your autopkg preference file.

`defaults write ~/Library/Preferences/com.github.autopkg.plist JC_DIST yourAwsS3Bucket

## In a nutshell

AutoPkg can be used to manage applications in a number of ways, it's best used when employed as a one-to-many application. The JumpCloud Importer takes input from .pkg recipe and applies JumpCloud logic to make it available to your JumpCloud systems.

When creating an override, add the JumpCloud Processor in the Process array of a given recipe

```XML
<key>ParentRecipe</key>
<string>com.github.autopkg.AutoPkgGitMaster</string>
<key>Process</key>
<array>
    <dict>
        <key>Processor</key>
        <string>workman.JumpCloudImporter/JumpCloudImporter</string>
        <key>Arguments</key>
        <dict>
            <key>JC_DIST</key>
            <string>AWS</string>
            <key>JC_SYSGROUP</key>
            <string>%NAME%-AutoPkg-%version%</string>
        </dict>
    </dict>
</array>
```

### Arguments/ Input Variables

#### JC_API

The JC_API input variable is the only input variable which is not passed in via the recipe. The API key is set as a key in the com.github.autopk preference file located at ~/Library/Preferences/com.github.autopkg.plist. The JC_API key can be set as a recipe variable but it seems cumbersome to copy that into each recipe.

#### JC_SYSGROUP

This input variable is the name of the smart group built using system insights. In the example above %NAME%-AutoPkg-%version% should build a smart group (and command) with the name of the given software package and version. Ex. Firefox-AutoPkg-72.02

#### JC_USER

This input variable is used when building commands, the id of a command runner may be passed into this variable field. By default the root user account is assigned to the commands built with this processor. 

#### JC_TYPE

There are three valid values which can be passed into each the JC_TYPE field:$$
self, auto or update.

self: This type of AutoPkg run builds a group and command based on the JC_SYSGROUP variable. Given that System Insights is requires to query systems for applications, a JC_TYPE of self would not invoke System Insights for this task. Manual assignment of systems would be required.

auto: This type of AutoPkg run queries systems in your organization and cross references the title and version of applications on systems with the title of software from an AutoPkg recipe. For example running the Firefox recipe would query JumpCloud systems for the following:
Does the system have Firefox?
Is the installed version of Firefox up to date (based on the recipe definition)?

If a system does not have Firefox or if that system has an out-of-date version of Firefox, it would be added to the group. Commands assigned to this group are assigned with the run once context. After the command runs, the system would take itself out of the group.

update: same as auto (#FIXME: delete this)

#### JC_DIST

Either "AWS" or "NULL" can be passed into this field. 


### Adding the JumpCloud Importer to AutoPkg

Copy the JumpCloudImporter.py file to `/Library/AutoPkg/autopkglib/` to make the importer available in the AutoPkg system context.

## JumpCloud Recipe Repo

Pending approval from AutoPkg, clone the github.com/autopkg/recipes/jumpcloud-recipes repo to begin importing autopkg software to you S3 bucket and deployment commands to JumpCloud.

## AutoPKG 2.0+ Dependencies

AutoPkg 2.0 contains it's own version of python3, the following modules should be installed to the AutoPkg python3 framework as they are out of the scope of the standard python modules. 

```bash
sudo /usr/local/autopkg/python -m pip install git+https://github.com/TheJumpCloud/jcapi-python.git#subdirectory=jcapiv1
sudo /usr/local/autopkg/python -m pip install git+https://github.com/TheJumpCloud/jcapi-python.git#subdirectory=jcapiv2
sudo /usr/local/autopkg/python -m pip install boto3
```

## AWS Distribution Points

Currently, a 1MB file size limit exists for all files on JumpCloud commands. By uploading packages to a distribution point and referencing that package's url code. The `awscli` is required to process packages and add AWS objects. By using this software you accept any and all costs associated with Amazon Web Services.

Install the AWS Cli:

```bash
pip install awscli
```

Setup AWS Credentials:

```bash
aws configure
```

Before making a bucket public, attempt to run the processor with a recipe and check the output, a .pkg file should be uploaded to s3.
