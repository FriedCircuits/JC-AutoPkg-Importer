# JumpCloud AutoPkg Importer

JumpCloud can leverage [AutoPkg](https://github.com/autopkg/autopkg) to automate package testing and deployment. Administrators familiar with AutoPkg can use .jumpcloud template recipes to develop their own .pkg overrides. Those unfamiliar with AutoPkg should visit the [AutoPkg wiki](https://github.com/autopkg/autopkg/wiki) page for more documentation. In sum, the JumpCloudImporter was developed to help admins import packages packages to distribution points and automatically create deployable JumpCloud commands for JumpCloud systems.

## Installation and Setup

### Prerequisites

- Python 3.5.x+
- JumpCloud Tenant
- AutoPkg 2.x+
- awscli to store AWS credentials
- Python Modules installed to AutoPkg's embedded copy of Python
  - JumpCloud APIs V1 and V2
  - Boto3
  
### Optional Settings

- JumpCloud System Insights

JumpCloud System Insights are required to query systems for application versions. By default AutoPkg JumpCloud recipes can run without system insights but the real power of patch management and the AutoPkg JumpCloud importer comes from querying system versions.

## In a nutshell

The JumpCloud Importer takes input from .pkg recipe and uses the JumpCloud API to build a system group & command for deployment to JumpCloud systems.

AutoPkg recipes can be overridden and it's best practice to do just that. Overridden package are generally saved locally and trusted. When the parent recipe changes, AutoPkg should notify you of the change and an admin can inspect the recipe for validity before accepting it's changes. [How (Not) To Do Bad Things With AutoPkg](https://www.youtube.com/watch?v=LnvQmLcDF8w)

When creating an override, add the JumpCloud Processor in the Process array of a given recipe. Example recipes are located in the [jumpcloud-recipes]((https://github.com/jworkmanjc/jumpcloud-recipes)) repo.

```XML
<key>ParentRecipe</key>
<string>com.github.autopkg.AutoPkgGitMaster</string>
<key>Process</key>
<array>
    <dict>
        <key>Processor</key>
        <string>workman.JumpCloudImporter/JumpCloudImporter</string>
        <key>Arguments</key>
        <dict>
            <key>JC_DIST</key>
            <string>AWS</string>
            <key>JC_SYSGROUP</key>
            <string>%NAME%-AutoPkg-%version%</string>
            <key>JC_TYPE</key>
            <string>auto</string>
        </dict>
    </dict>
</array>
```

### Arguments/ Input Variables

#### JC_API

The JC_API input variable is the only input variable which is not passed in via the recipe. The API key is set as a key in the com.github.autopkg preference file located at ~/Library/Preferences/com.github.autopkg.plist. The JC_API key can be set as a recipe variable but it seems cumbersome to copy that into each recipe.

After installing the latest version of AutoPKG, add your JumpCloud API key to the AutoPkg:

`defaults write ~/Library/Preferences/com.github.autopkg.plist JC_API yourApiKey`

Note: Your API key is stored on a local system when the above command is used, evaluate whether or not this meets the security requirements of your organization. Receipts for each package are generated by default, those receipts will contain your a copy of your API key unless other specified actions are made.

#### JC_SYSGROUP

This input variable is the name of the smart group built using system insights. In the example above AutoPkg-%NAME%-%version% should build a smart group (and command) with the name of the given software package and version. Ex. AutoPkg-Firefox-72.02

#### JC_USER

This input variable is used when building commands, the id of a command runner may be passed into this variable field. By default the root user account is assigned to the commands built with this processor. 

#### JC_TYPE

There are three valid values which can be passed into each the JC_TYPE field:
self, auto or update.

self: This type of AutoPkg run builds a group and command based on the JC_SYSGROUP variable. Given that System Insights is requires to query systems for applications, a JC_TYPE of self would not invoke System Insights for this task. Manual assignment of systems would be required.

auto: This type of AutoPkg run queries systems in your organization and cross references the title and version of applications on systems with the title of software from an AutoPkg recipe. For example running the Firefox recipe would query JumpCloud systems for the following:
Does the system have Firefox?
Is the installed version of Firefox up to date (based on the recipe definition)?

If a system does not have Firefox or if that system has an out-of-date version of Firefox, it would be added to the group. Commands assigned to this group are assigned with the run once context. After the command runs, the system would take itself out of the group.

update: This type of AutoPkg run builds a system group (if it does not exist) and only adds systems which currently have the AutoPkg app installed. Those systems who's version of the app are out of data are kept in the system group. This run type can remove systems without the specified app from the system group if the group exists and systems without the group are in that group. Admins who only wish to update systems with an app can use the update type to run app updates.

#### JC_DIST

At this point only "AWS" can be passed into this field.

#TODO: in the future it would be nice to upload right to JumpCloud.
#TODO: it would be nice to upload to a https distribution point if one existed

#### AWS_BUCKET

This is the bucket name required for AWS. the default value is "jcautopkg" so if that bucket name does not exist, the processor will fail.

### Adding the JumpCloud Importer to AutoPkg

Copy the JumpCloudImporter.py file to `/Library/AutoPkg/autopkglib/` to make the importer available in the AutoPkg system context.

## JumpCloud Recipe Repo

#TODO: This repository needs work, I've tested some recipes and have those saved to the [jumpcloud-recipes](https://github.com/jworkmanjc/jumpcloud-recipes) repo.

Pending approval from AutoPkg, clone the github.com/autopkg/recipes/jumpcloud-recipes repo to begin importing autopkg software to you S3 bucket and deployment commands to JumpCloud.

## AutoPKG 2.0+ Dependencies

AutoPkg 2.0 contains it's own distribution of Python3, the following modules should be installed to the AutoPkg python3 framework as they are out of the scope of the standard python modules. All the modules below are referenced by the JumpCloud AutoPkg Importer during an AutoPkg run, they need to be made available to AutoPkg's distribution of Python3

Install the [JumpCloud Python APIs, v1 and v2](https://github.com/TheJumpCloud/jcapi-python)

```bash
sudo /usr/local/autopkg/python -m pip install git+https://github.com/TheJumpCloud/jcapi-python.git#subdirectory=jcapiv1
sudo /usr/local/autopkg/python -m pip install git+https://github.com/TheJumpCloud/jcapi-python.git#subdirectory=jcapiv2
```

Install the [AWS SKD boto3](https://boto3.amazonaws.com/v1/documentation/api/latest/guide/quickstart.html)

```bash
sudo /usr/local/autopkg/python -m pip install boto3
```

## AWS Distribution Points

Currently, a 1MB file size limit exists for all files on JumpCloud commands, as such AWS S3 buckets are used to store larger files. The JumpCloud AutoPkg Importer uploads packages to an S3 bucket and returned the bucket item's url. The AWS SDK is required to process packages and add AWS objects, the AWS CLI is required to authenticate to S3. By using this software you accept any and all costs associated with Amazon Web Services.

[Install the AWS Cli](https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2.html):

Setup AWS Credentials:

```bash
aws configure
```

## Bucket configuration

#TODO: Figure out best way to do this.

Build and name a bucket. Make the bucket accessible to your systems. Before making a bucket public, attempt to run the processor with a recipe and check the output, a .pkg file should be uploaded to s3.

Here's an example bucket policy for systems public access to GetObject. Create a bucket policy that fits the needs of your org.

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "PublicRead",
            "Effect": "Allow",
            "Principal": "*",
            "Action": "s3:GetObject",
            "Resource": "arn:aws:s3:::jcautopkg/*"
        }
    ]
}
```

## Acknowledgments

As a long time JSS importer user, I would like to thank Shea Craig and Allister Banks for their work in the mac admin community and their work on the JSS importer which made my life much easier and served as inspiration for this project.